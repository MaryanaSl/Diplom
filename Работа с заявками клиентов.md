# Работа с заявками клиентов

## Договоры на абонентское обслуживание

Необходимо добавить новый вид договоров – абоненское обслуживание. В договорах такого вида пользователь должен иметь возможность внести дату начала действия договора, дату окончания действия договора, сумму ежемесячной абоненсткой платы и стоимость часа работы специалиста.

## Обслуживание клиентов

Необходимо планировать обслуживание сотрудниками оборудования и программ клиентов. 

Процесс работы с заявками построен следующим образом:
1. Клиент звонит менеджеру и оставляет заявку на работу специалиста с указанием проблемы, для решения которой нужен специалист.
2. Менеджер ищет свободное время и планирует заявку на это время.
3. При планировании телеграм-бот оповещает специалистов о появлении новой заявки.
4. Специалист в назначенное время в офисе клиента или удалённо проводит необходимые работы.
5. Специалист получает подписанный лист учёта рабочего времени или скан/фото листа учёта от клиента. В листе учёта перечисляются виды работ, выполненные специалистом, и фиксируется количество часов к оплате. В дальнейшем документ будет являться подтверждением проведения работ.
6. Специалист вносит в информационную систему информацию о выполненных работах, количество фактически потраченных часов на каждый вид работы, количество часов к оплате клиенту за каждый вид работы и прикрепляет к документу скан/фото листа учёта рабочего времени.

Все объекты, связанные с обслуживанием клиентов, должны располагаться в новой подсистеме Обслуживание клиентов.

**Реализованное решение**
1. Добавлен документ ОбслуживаниеКлиента с реквизитами:
    - Клиент
    - Договор
    - Специалист
    - Дата проведения работ
    - Время начала работ (план)
    - Время окончания работ (план)
    - Описание проблемы
    - Комментарий
2. В документ добавлена табличная часть ВыполненныеРаботы с колонками:
    - Описание работ
    - Фактически потрачено часов
    - Часы к оплате клиенту
3. Реализована форма документа и форма списка с разумным размещением полей, подключена к формам подсистема Подключаемые команды
4. Добавлена возможность хранить присоединенные к документу файлы
5. Создана роль для работы с документом
6. Добавлен регистр накопления для хранения информации о суммах задолженности клиента ВыполненныеКлиентуРаботы
    - Измерения - Клиент, Договор
    - Ресурсы - Количество часов, Сумма к оплате
7. Реализована проверка при проведении документа, что выбран договор с типом абонентская плата и что дата документа лежит между датой начала и датой окончания действия договора

```bsl
Процедура ОбработкаПроведения(Отказ, Режим)

	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записывать = Истина;
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записывать = Истина;
	
	Движения.ВКМ_ВыполненныеКлиентуРаботы.Записать();
	Движения.ВКМ_ВыполненныеСотрудникомРаботы.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Дата КАК Дата,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_ДатаНачала КАК ДатаНачалаДоговора,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_ДатаОкончания КАК ДатаОкончанияДоговора,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВидДоговора КАК ВидДоговора,
		|	СУММА(ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.ЧасыКОплатеКлиенту) КАК КоличествоЧасов,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Клиент КАК Клиент,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор КАК Договор,
		|	СУММА(ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Сумма) КАК СуммаКОплате,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Специалист КАК Сотрудник,
		|	МАКСИМУМ(ВКМ_УсловияОплатыСотрудниковСрезПоследних.ПроцентОтРабот) КАК ПроцентОтРабот,
		|	МАКСИМУМ(ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_СтоимостьЧасаРаботы) КАК СтоимостьЧасаРаботы,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_СуммаАбонентскойПлаты КАК СуммаАбонентскойПлаты
		|ИЗ
		|	Документ.ВКМ_ОбслуживаниеКлиента.ВыполненныеРаботы КАК ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВКМ_УсловияОплатыСотрудников.СрезПоследних(&Дата, Сотрудник В
		|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
		|				ВКМ_ОбслуживаниеКлиента.Специалист
		|			ИЗ
		|				Документ.ВКМ_ОбслуживаниеКлиента КАК ВКМ_ОбслуживаниеКлиента)) КАК ВКМ_УсловияОплатыСотрудниковСрезПоследних
		|		ПО ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Специалист = ВКМ_УсловияОплатыСотрудниковСрезПоследних.Сотрудник
		|ГДЕ
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка = &Ссылка
		|СГРУППИРОВАТЬ ПО
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Дата,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_ДатаНачала,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_ДатаОкончания,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВидДоговора,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Клиент,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Специалист,
		|	ВКМ_ОбслуживаниеКлиентаВыполненныеРаботы.Ссылка.Договор.ВКМ_СуммаАбонентскойПлаты";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Дата", Дата);
		
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
		Если ВыборкаДетальныеЗаписи.ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание Тогда 
			Отказ = Истина;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Вид договора не является абонентским обслуживанием");
			Прервать;
		КонецЕсли;
		
		Если ВыборкаДетальныеЗаписи.Дата > КонецДня(ВыборкаДетальныеЗаписи.ДатаОкончанияДоговора)
			Или ВыборкаДетальныеЗаписи.Дата < ВыборкаДетальныеЗаписи.ДатаНачалаДоговора
			Тогда
			Отказ = Истина;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Дата документа должна быть в границах действия договора на абоненсткое обслуживание!");
			Прервать;
		КонецЕсли;	
		
		Если ПустаяСтрока(ВыборкаДетальныеЗаписи.ПроцентОтРабот) Тогда
			Отказ = Истина;
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Специалисту не установлен процент оплаты от работ!");
			Прервать;
		КонецЕсли;	
		
		//регистр ВКМ_ВыполненныеКлиентуРаботы
		Движение = Движения.ВКМ_ВыполненныеКлиентуРаботы.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
		Движение.Период = Дата;
		
		//регистр ВКМ_ВыполненныеСотрудникомРаботы
		Движение = Движения.ВКМ_ВыполненныеСотрудникомРаботы.Добавить();
		Движение.Период = Дата;
		Движение.Сотрудник = ВыборкаДетальныеЗаписи.Сотрудник;
		Движение.ЧасовКОплате = ВыборкаДетальныеЗаписи.КоличествоЧасов;
		Движение.Процент = СтроковыеФункцииКлиентСервер.СтрокаВЧисло(ВыборкаДетальныеЗаписи.ПроцентОтРабот);
		Движение.СуммаКОплате = ВыборкаДетальныеЗаписи.КоличествоЧасов * ВыборкаДетальныеЗаписи.СтоимостьЧасаРаботы * Движение.Процент / 100;

			
	КонецЦикла;


КонецПроцедуры
```

8. Реализована обработка проведения по регистру накопления. Сумма к оплате рассчитывается исходя из ставки часа, указанной в договоре
9. Добавлен документ в подсистему Обслуживание клиентов
10. Для оповещения через Телеграм созданы константы:
    - токен управления телеграм-ботом
    - идентификатор группы для оповещения
11. Реализован отдельный общий модуль для интеграции с телеграм-ботом (ВКМ_ИнтеграцияТГ)

```bsl
    #Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныеПроцедурыИФункции

Процедура ОтправитьСообщение () Экспорт

	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ВКМ_ИдентификторГруппыДляОповещения.Значение КАК Chat_id,
		|	ВКМ_ТокенУправленияТГБотом.Значение КАК TokenTG,
		|	ВКМ_УведомленияТГБот.Ссылка,
		|	ВКМ_УведомленияТГБот.Текст
		|ИЗ
		|	Константа.ВКМ_ТокенУправленияТГБотом КАК ВКМ_ТокенУправленияТГБотом,
		|	Константа.ВКМ_ИдентификторГруппыДляОповещения КАК ВКМ_ИдентификторГруппыДляОповещения,
		|	Справочник.ВКМ_УведомленияТГБот КАК ВКМ_УведомленияТГБот";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	
	Пока Выборка.Следующий () Цикл
		TokenTG = Выборка.TokenTG;
		Chat_id = Выборка.Chat_id;
		
		Результат = ОтправкаЗаявкиТГ(Выборка.Текст, TokenTG, Chat_id);
			Если Результат Тогда
				Объект = Выборка.Ссылка.ПолучитьОбъект();
				Объект.Удалить();
			КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция ОтправкаЗаявкиТГ (Текст, Токен, ЧатИД)
		
		АдресТГ = "api.telegram.org";
		Соединение  =  Новый HTTPСоединение(АдресТГ,443,,,,,Новый ЗащищенноеСоединениеOpenSSL());
		
		Данные = Новый Структура();
		Данные.Вставить("text", Текст);
		
				
		ПараметрыЗаписи = Новый ПараметрыЗаписиJSON(, Символы.Таб);
		
		Запись = Новый ЗаписьJSON;
		Запись.УстановитьСтроку(ПараметрыЗаписи);
		ЗаписатьJSON(Запись, Данные);
		СтрокаJSON = Запись.Закрыть();
		
		Заголовки = Новый Соответствие();
		Заголовки.Вставить("Content-Type", "application/json");
		АдресЗапроса = "bot" + Токен + "/sendMessage?chat_id=" + Формат(ЧатИД, "ЧГ=");
		
		Запрос = Новый HTTPЗапрос(АдресЗапроса, Заголовки);
		Запрос.УстановитьТелоИзСтроки(СтрокаJSON);
		
		Попытка
			Результат = Соединение.ОтправитьДляОбработки(Запрос);
		Исключение
			ЗаписьЖурналаРегистрации(НСтр("ru = 'Выполнение операции'"),
			УровеньЖурналаРегистрации.Ошибка, , ,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;
		
		Если Результат.КодСостояния = 200 Тогда
			Возврат Истина;
		КонецЕсли;
		
		Возврат Ложь;
		
	КонецФункции

#КонецОбласти
#КонецЕсли
```


13. Создан справочник Уведомления телеграм-боту для отправки с нулевой длиной кода и наименования и реквизитом Текст сообщения (строка бесконечной длины)
14. При записи документа Обслуживание клиента, если документ записывается первый раз или если дата, время или специалист изменились, добавлено в справочник сообщение с текстом, описывающим изменения. Модуль объекта:

```bsl
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Если ЭтоНовый() Тогда
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Создана новая заявка от %1 для обслуживания клиента %2", Дата, Клиент);
		ОбъектУведомленияТГ.Записать();

	КонецЕсли;

	ДатаДокумента = '00010101';
	ДатаПроведенияРаботДок = '00010101';
	ВремяНачалаРаботПланДок =  '00010101000000';
	ВремяОкончанияРаботПланДок =  '00010101000000';
	СпециалистДок = " ";
	
	Если Не ЭтоНовый() Тогда
	 Запрос = Новый Запрос;
	 Запрос.Текст =
	 	"ВЫБРАТЬ
	 	|	ВКМ_ОбслуживаниеКлиента.Дата КАК ДатаДокумента,
	 	|	ВКМ_ОбслуживаниеКлиента.ДатаПроведенияРабот,
	 	|	ВКМ_ОбслуживаниеКлиента.ВремяНачалаРаботПлан,
	 	|	ВКМ_ОбслуживаниеКлиента.ВремяОкончанияРаботПлан,
	 	|	ВКМ_ОбслуживаниеКлиента.Специалист
	 	|ИЗ
	 	|	Документ.ВКМ_ОбслуживаниеКлиента КАК ВКМ_ОбслуживаниеКлиента
	 	|ГДЕ
	 	|	ВКМ_ОбслуживаниеКлиента.Ссылка = &Ссылка";
	 
	 Запрос.УстановитьПараметр("Ссылка", Ссылка);
	 
	 РезультатЗапроса = Запрос.Выполнить();
	 
	 Выборка = РезультатЗапроса.Выбрать();
	 
	 Если Выборка.Следующий() Тогда
	 	ДатаДокумента = Выборка.ДатаДокумента;
	 	ДатаПроведенияРаботДок = Выборка.ДатаПроведенияРабот;
	 	ВремяНачалаРаботПланДок = Выборка.ВремяНачалаРаботПлан;
	 	ВремяОкончанияРаботПланДок = Выборка.ВремяОкончанияРаботПлан;
	 	СпециалистДок = Выборка.Специалист; 
	 КонецЕсли;

	Если ДатаДокумента <> Дата Тогда
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Изменена дата в заявке № %1. Новая дата: %2", Номер, Дата);
		ОбъектУведомленияТГ.Записать();

	КонецЕсли;
	
	Если ДатаПроведенияРаботДок <> ДатаПроведенияРабот Тогда 	 
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Изменена дата проведения работ в заявке № %1. Новая дата проведения работ: %2", Номер, ДатаПроведенияРабот);
		ОбъектУведомленияТГ.Записать();
		
	КонецЕсли;
	
	Если ВремяНачалаРаботПланДок <> ВремяНачалаРаботПлан Тогда 	
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Изменено плановое время начала работ в заявке № %1. Новое плановое время: %2", Номер, Формат(ВремяНачалаРаботПлан,"ДЛФ=T;"));
		ОбъектУведомленияТГ.Записать();
	КонецЕсли;
	
	Если ВремяОкончанияРаботПланДок <> ВремяОкончанияРаботПлан Тогда
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Изменено плановое время окончания работ в заявке № %1. Новое плановое время: %2", Номер, Формат(ВремяОкончанияРаботПлан,"ДЛФ=T;"));
		ОбъектУведомленияТГ.Записать();
	КонецЕсли;
	
	Если СпециалистДок <> Специалист Тогда
		ОбъектУведомленияТГ = Справочники.ВКМ_УведомленияТГБот.СоздатьЭлемент();
		ОбъектУведомленияТГ.Текст = СтрШаблон("Изменен специалист в заявке № %1. Новый специалист: %2", Номер, Специалист);
		ОбъектУведомленияТГ.Записать();
	КонецЕсли;
	
	КонецЕсли;
	

КонецПроцедуры


#КонецОбласти
#КонецЕсли
```

15. Добавлено регламентное задание, которое обходит элементы справочника Уведомления, отправляет и после успешной отправки удаляет элементы справочника.
![image](https://github.com/user-attachments/assets/3e3ea480-3584-4dd8-8ee9-5a64fb038fd2)


## Заполнение Реализации товаров и услуг

Если в документе Реализации товаров и услуг выбран договор с видом абонентская плата, то необходимо реализовать возможность автозаполнения такого документа суммой ежемесячной абонентской платы и суммой за выполненные в течения месяца работы по данным документов Обслуживание клиентов.
Из документа должен печататься акт об оказанных услугах.

* Модуль объекта документа Реализация

```bsl
	// {{ Слукина М.Н.: Необходимо реализовать процедуру ВыполнитьАвтозаполнение 

	//получить номенклатуру из констант НоменклатураАбонентскаяПлата и 
	//НоменклатураРаботыСпециалиста, если хотя бы одна не заполнена, 
	//необходимо выдать ошибку и прекратить выполнение процедуры,

	//очистить табличную часть.

	//Если в договоре ненулевая сумма абонентской платы, 
	//добавить в табличную часть строку с номенклатурой из константы 
	//НоменклатураАбонентскаяПлата и суммой абонентской платы из договора.

	//Если в месяц даты документа в регистре ВыполненныеКлиентуРаботы 
	//есть информация о выполненных работах по этому договору, 
	//добавить в ЧТ строку с номенклатурой из константы НоменклатураРаботыСпециалиста и 
	//общим количеством и суммой из регистра ВыполненныеКлиентуРаботы за месяц документа.

Процедура ВыполнитьАвтозаполнение() Экспорт
	
	НоменклатураАбонентскаяПлата = Константы.ВКМ_НоменклатураАбонентскаяПлата.Получить();
	НоменклатураРаботыСпециалиста = Константы.ВКМ_НоменклатураРаботыСпециалиста.Получить();
	
	Если Не ЗначениеЗаполнено(НоменклатураАбонентскаяПлата) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Необходимо заполнить константу номенклатура абонентская плата");
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(НоменклатураРаботыСпециалиста) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Необходимо заполнить константу номенклатура работы специалиста");
		Возврат;
	КонецЕсли;

	Товары.Очистить();
	Услуги.Очистить();
	
Запрос = Новый Запрос;
Запрос.Текст =
	"ВЫБРАТЬ
	|	ВКМ_ВыполненныеКлиентуРаботыОбороты.Клиент,
	|	ВКМ_ВыполненныеКлиентуРаботыОбороты.Договор,
	|	СУММА(ЕСТЬNULL(ВКМ_ВыполненныеКлиентуРаботыОбороты.КоличествоЧасовОборот, 0)) КАК КоличествоЧасов,
	|	СУММА(ЕСТЬNULL(ВКМ_ВыполненныеКлиентуРаботыОбороты.СуммаКОплатеОборот, 0)) КАК СуммаКОплате,
	|	ДоговорыКонтрагентов.ВКМ_СуммаАбонентскойПлаты КАК СуммаАбонентскойПлаты
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВКМ_ВыполненныеКлиентуРаботы.Обороты(&НачалоПериода, &КонецПериода,,
	|			Договор = &Ссылка) КАК ВКМ_ВыполненныеКлиентуРаботыОбороты
	|		ПО ДоговорыКонтрагентов.Ссылка = ВКМ_ВыполненныеКлиентуРаботыОбороты.Договор
	|		И ДоговорыКонтрагентов.Владелец = ВКМ_ВыполненныеКлиентуРаботыОбороты.Клиент
	|ГДЕ
	|	ДоговорыКонтрагентов.Ссылка = &Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ВКМ_ВыполненныеКлиентуРаботыОбороты.Договор,
	|	ВКМ_ВыполненныеКлиентуРаботыОбороты.Клиент,
	|	ДоговорыКонтрагентов.ВКМ_СуммаАбонентскойПлаты";

Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(Дата));
Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(Дата));
Запрос.УстановитьПараметр("Ссылка", Договор);


РезультатЗапроса = Запрос.Выполнить();

ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();


Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	
		Если ВыборкаДетальныеЗаписи.СуммаАбонентскойПлаты <> 0 Тогда
			НоваяСтрокаТЧ = Услуги.Добавить();
			НоваяСтрокаТЧ.Номенклатура = НоменклатураАбонентскаяПлата;
			НоваяСтрокаТЧ.Количество = 1;
			НоваяСтрокаТЧ.Сумма = ВыборкаДетальныеЗаписи.СуммаАбонентскойПлаты;
		КонецЕсли;
	
		Если ВыборкаДетальныеЗаписи.КоличествоЧасов <> 0 Тогда
			НоваяСтрокаТЧ = Услуги.Добавить();
			НоваяСтрокаТЧ.Номенклатура = НоменклатураРаботыСпециалиста;
			НоваяСтрокаТЧ.Количество = ВыборкаДетальныеЗаписи.КоличествоЧасов;
			НоваяСтрокаТЧ.Сумма = ВыборкаДетальныеЗаписи.СуммаКОплате;
		КонецЕсли;

КонецЦикла;

КонецПроцедуры

//}}
```
* Акто об оказанных услугах
![image](https://github.com/user-attachments/assets/fb7ed54f-1978-4192-be95-54839d00a312)

Модуль менеджера документа Реализация

```bsl
//{{ Слукина М.Н. добавление команды печати и акта об оказании услуг в документ

Процедура ПриОпределенииНастроекПечати(НастройкиОбъекта) Экспорт	
	НастройкиОбъекта.ПриДобавленииКомандПечати = Истина;
КонецПроцедуры

Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
	// Акт об оказании услуг
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "Акт";
	КомандаПечати.Представление = НСтр("ru = 'Акт об оказании услуг'");
	КомандаПечати.Порядок = 5;
	
КонецПроцедуры

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	ПечатнаяФорма = УправлениеПечатью.СведенияОПечатнойФорме(КоллекцияПечатныхФорм, "Акт");
	Если ПечатнаяФорма <> Неопределено Тогда
	    ПечатнаяФорма.ТабличныйДокумент = ПечатьАкта(МассивОбъектов, ОбъектыПечати);
	    ПечатнаяФорма.СинонимМакета = НСтр("ru = 'Акт об оказании услуг'");
	    ПечатнаяФорма.ПолныйПутьКМакету = "Документ.РеализацияТоваровУслуг.ВКМ_ПФ_MXL_АктОбОказанныхУслугах";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПечатьАкта (МассивОбъектов, ОбъектыПечати)
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.КлючПараметровПечати = "ПараметрыПечати_Акт";
	
	Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.РеализацияТоваровУслуг.ВКМ_ПФ_MXL_АктОбОказанныхУслугах");
	
	ДанныеДокументов = ПолучитьДанныеДокументов(МассивОбъектов);
	
	ПервыйДокумент = Истина;
	
	Пока ДанныеДокументов.Следующий() Цикл
		
		Если Не ПервыйДокумент Тогда
			// Все документы нужно выводить на разных страницах.
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;
		
		ПервыйДокумент = Ложь;
		
		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
	
		ВывестиОбластьШапка(ДанныеДокументов, ТабличныйДокумент, Макет);
		
		ВывестиКонтрагентОрганизацияДоговор(ДанныеДокументов, ТабличныйДокумент, Макет);
		
		ВывестиТоварыУслуги(ДанныеДокументов, ТабличныйДокумент, Макет);
		
		ВывестиПодписи (ДанныеДокументов, ТабличныйДокумент, Макет);
	
		// В табличном документе необходимо задать имя области, в которую был 
		// выведен объект. Нужно для возможности печати комплектов документов.
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабличныйДокумент, 
		НомерСтрокиНачало, ОбъектыПечати, ДанныеДокументов.Ссылка);		
		
	КонецЦикла;	
	
	Возврат ТабличныйДокумент;
	
КонецФункции

Процедура ВывестиОбластьШапка(ДанныеДокументов, ТабличныйДокумент, Макет)
	ОбластьШапка = Макет.ПолучитьОбласть ("Шапка"); 
	ОбластьШапка.Параметры.ДатаДокумента = Формат (ДанныеДокументов.Дата, "ДФ=dd.MM.yyyy") + " г.";
	ОбластьШапка.Параметры.НомерДокумента = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ДанныеДокументов.Номер);
	ТабличныйДокумент.Вывести(ОбластьШапка);
КонецПроцедуры

Процедура ВывестиКонтрагентОрганизацияДоговор(ДанныеДокументов, ТабличныйДокумент, Макет)
	
	ОбластьКонтрагент = Макет.ПолучитьОбласть("Контрагент");
	ОбластьОрганизация = Макет.ПолучитьОбласть("Организация");
	ОбластьДоговор = Макет.ПолучитьОбласть("Договор");
	
	ДанныеПечати = Новый Структура;
	ДанныеПечати.Вставить("ПредставлениеКонтрагента", ДанныеДокументов.Контрагент);
	ДанныеПечати.Вставить("ПредставлениеОрганизации", ДанныеДокументов.Организация);
	ДанныеПечати.Вставить("Договор", ДанныеДокументов.Договор);
	
	ОбластьКонтрагент.Параметры.Заполнить(ДанныеПечати);
	ТабличныйДокумент.Вывести(ОбластьКонтрагент);
	
	ОбластьОрганизация.Параметры.Заполнить(ДанныеПечати);
	ТабличныйДокумент.Вывести(ОбластьОрганизация);
	
	ОбластьДоговор.Параметры.Заполнить(ДанныеПечати);
	ТабличныйДокумент.Вывести(ОбластьДоговор);
	
КонецПроцедуры

Процедура ВывестиТоварыУслуги(ДанныеДокументов, ТабличныйДокумент, Макет)
	
	ОбластьШапкаТЧ = Макет.ПолучитьОбласть("ШапкаТЧ");
	ОбластьСтрока = Макет.ПолучитьОбласть("СтрокаТЧ");
	ОбластьВсего = Макет.ПолучитьОбласть("Всего");
	ОбластьСуммаПрописью = Макет.ПолучитьОбласть("СуммаПрописью");
	
	ТабличныйДокумент.Вывести(ОбластьШапкаТЧ);
	
	ВыборкаТовары = ДанныеДокументов.Товары.Выбрать();
	Пока ВыборкаТовары.Следующий() Цикл
		ОбластьСтрока.Параметры.Заполнить(ВыборкаТовары);
		ТабличныйДокумент.Вывести(ОбластьСтрока);
	КонецЦикла;
	
	ВыборкаУслуги = ДанныеДокументов.Услуги.Выбрать();
	Пока ВыборкаУслуги.Следующий() Цикл
		ОбластьСтрока.Параметры.Заполнить(ВыборкаУслуги);
		ТабличныйДокумент.Вывести(ОбластьСтрока);
	КонецЦикла;
	
	ДанныеПечати = Новый Структура;
	ДанныеПечати.Вставить("Всего", ДанныеДокументов.СуммаДокумента);
	
	ОбластьВсего.Параметры.Заполнить(ДанныеПечати);
	ТабличныйДокумент.Вывести(ОбластьВсего);
	
	ДанныеСуммы = Новый Структура;
	ДанныеСуммы.Вставить ("СуммаПрописью", ЧислоПрописью(ДанныеДокументов.СуммаДокумента, "Л=ru_RU; ДП = Ложь", "рубль, рубля, рублей, м, копейка, копейки, копеек, ж, 2"));
	
	ОбластьСуммаПрописью.Параметры.Заполнить(ДанныеСуммы);
	ТабличныйДокумент.Вывести(ОбластьСуммаПрописью);
	
КонецПроцедуры

Процедура ВывестиПодписи(ДанныеДокументов, ТабличныйДокумент, Макет)
	
	ОбластьПодписи = Макет.ПолучитьОбласть("Подписи");
	ОбластьПодписи.Параметры.Контрагента = ДанныеДокументов.Контрагент;
	ОбластьПодписи.Параметры.Организации = ДанныеДокументов.Организация;

	ТабличныйДокумент.Вывести(ОбластьПодписи);
	
КонецПроцедуры

Функция ПолучитьДанныеДокументов(МассивОбъектов)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Ссылка,
	|	РеализацияТоваровУслуг.Номер,
	|	РеализацияТоваровУслуг.Дата,
	|	РеализацияТоваровУслуг.Организация,
	|	РеализацияТоваровУслуг.Контрагент,
	|	РеализацияТоваровУслуг.Договор,
	|	РеализацияТоваровУслуг.СуммаДокумента,
	|	РеализацияТоваровУслуг.Ответственный,
	|	РеализацияТоваровУслуг.Товары.(
	|		Ссылка,
	|		НомерСтроки,
	|		Номенклатура,
	|		Количество,
	|		Цена,
	|		Сумма),
	|	РеализацияТоваровУслуг.Услуги.(
	|		Ссылка,
	|		НомерСтроки,
	|		Номенклатура,
	|		Количество,
	|		Цена,
	|		Сумма)
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка В (&МассивОбъектов)";
	
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции

#КонецОбласти
//}}
```

## Массовое создание документов Реализация товаров и услуг

В начале месяца бухгалтер фирмы формирует акты по всем абонентским договорам. Необходимо автоматизировать эту процедуру.

## Права доступа

Документы Обслуживание клиентов вводят специалисты и менджеры. Массовое создание документов Реализации использует бухгалтер. Для настройкии прав доступа добавляются поставляемые профили групп доступа и роли для работы с объектами

**Алгоритм решения задачи:**

